pipeline{
  agent any
  environment {

        imageName = "testnodeimage"
        registryCredentials = "nexus"
        registry = "192.168.33.10:8083"
        dockerImage = ''
         
    }
  stages {

 
 
  stage('Install dependencies') {
      steps{
        
        script {
         sh('npm install')
        }
      }
    }

stage('Unit Test') {
      steps{
        
        script {
         sh('npm test')
        }
      }
    }
     stage('SonarQube Analysis') {
      steps{
      script {

        sh(' docker start sonar ')
                    def scannerHome = tool 'scanner'
                    withSonarQubeEnv {
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }

      }
    
  }





    // Building Docker images
    stage('Building image (node and mongo)') {
      steps{
        
        script {
         sh('docker-compose build')
        }
      }
    }

    //  Uploading Docker images into Nexus Registry
    stage('Deploy  to Nexus') {
     steps{  
         script {
            sh(' docker start nexus ')

             docker.withRegistry("http://"+registry, registryCredentials ) {
            sh('docker push $registry/nodemongoapp:4.0 ')
          }
        }
      }
    }


       stage('Run application ') {
     steps{  
         script {
          
             docker.withRegistry("http://"+registry, registryCredentials ) {
            sh('docker-compose up -d ')
          }
        }
      }
    }


 stage("Run Prometheus"){
      steps{

        sh(' docker start prometheus')
      }
    }
     stage("Run Grafana"){ 
      steps{

        sh(' docker start grafana')
      }
    }
    
  }


}