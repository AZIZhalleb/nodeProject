pipeline{
  agent any
  environment {
        imageName = "mynodeapp"
        registryCredentials = "nexus"
        registry = "http://localhost:8081/repository/docker-hosted/"
        dockerImage = ''
    }
  stages {

    stage("npm install"){
      steps{

        echo 'Executing npm . . .'
        nodejs('Node-18.14.0'){
          sh 'npm install'

        }
      }
    }
     stage('SonarQube Analysis') {
      steps{
      script {
                    def scannerHome = tool 'scanner'
                    withSonarQubeEnv {
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }

      }
    
  }

  stage('Initialize Docker'){

    steps{
        def dockerHome = tool 'Docker'
        env.PATH = "${dockerHome}/bin:${env.PATH}"
    }

  }
    // Building Docker images
    stage('Building image') {
      steps{
        
        script {
          dockerImage = docker.build imageName
        }
      }
    }

      // Uploading Docker images into Nexus Registry
    stage('Uploading to Nexus') {
     steps{  
         script {
             docker.withRegistry( 'http://'+registry, registryCredentials ) {
             dockerImage.push('latest')
          }
        }
      }
    }

 stage("test"){
      steps{

        echo "Testingg . . ."
      }
    }
     stage("Deploy"){ 
      steps{

        echo "Deployingg. . ."
      }
    }
    
  }


}